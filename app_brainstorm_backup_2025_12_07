import streamlit as st
import json
import re
from datetime import datetime
from typing import Dict, Any, List, Union

import requests  # –î–ª—è –≤—ã–∑–æ–≤–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ LM Studio


# ==============================================================================
# 0. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
# ==============================================================================


def log_error(message: str):
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –≤ –≤–µ—á–Ω—ã–π –∂—É—Ä–Ω–∞–ª —Å–µ—Å—Å–∏–∏ (–Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)."""
    if 'debug_logs' not in st.session_state:
        st.session_state.debug_logs = []

    timestamp = datetime.now().strftime("%H:%M:%S")
    full_msg = f"[{timestamp}] {message}"
    st.session_state.debug_logs.append(full_msg)
    # –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –æ—à–∏–±–∫—É –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ø—É–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.


# ==============================================================================
# I. –î–ê–ù–ù–´–ï –ú–ï–¢–û–î–û–õ–û–ì–ò–ò
# ==============================================================================


PRESETS = {
    "üèîÔ∏è –ë—Ä–∞—Ç—Å—Ç–≤–æ –ö–æ–ª—å—Ü–∞ (–°–∫–∞—É—Ç–∏–Ω–≥ –ö–ª–∞—Å—Å–∏–∫–∞)": {
        "description": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å–∫–∞—É—Ç–∏–Ω–≥. –í–æ—Å–ø–∏—Ç–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ —á–µ—Ä–µ–∑ –∏—Å–ø—ã—Ç–∞–Ω–∏—è –ø—Ä–∏—Ä–æ–¥–æ–π.",
        "core": "–õ–∏–¥–µ—Ä—Å–∫–æ–µ (–°–∫–∞—É—Ç–∏–Ω–≥ / –ë.–ü.)",
        "engine": "Outdoor / –¢—É—Ä–∏–∑–º"
    },
    "üöÄ –°—Ç–∞—Ä—Ç–∞–ø-–ö—ç–º–ø (–ü—Ä–æ–µ–∫—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥)": {
        "description": "–°–º–µ–Ω–∞-–∏–Ω–∫—É–±–∞—Ç–æ—Ä. –î–µ—Ç–∏ —Å–æ–∑–¥–∞—é—Ç —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã –æ—Ç –∏–¥–µ–∏ –¥–æ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏.",
        "core": "–ü—Ä–æ–µ–∫—Ç–Ω–æ–µ (PBL / Dewey)",
        "engine": "Hard Skills / –ü—Ä–æ–µ–∫—Ç"
    },
    "üî• –û—Ä–ª—è—Ç—Å–∫–∏–π –ö—Ä—É–≥ (–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ –∏ –õ–∏–¥–µ—Ä—Å—Ç–≤–æ)": {
        "description": "–ü–µ–¥–∞–≥–æ–≥–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞. –í—Å–µ –¥–µ–ª–∞–µ–º —Ç–≤–æ—Ä—á–µ—Å–∫–∏ –∏ –≤–º–µ—Å—Ç–µ.",
        "core": "–°–æ–∑–∏–¥–∞—Ç–µ–ª—å–Ω–æ–µ (–ò–≤–∞–Ω–æ–≤ / –ö–¢–î)",
        "engine": "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ / –ê—Ä—Ç"
    },
    "üé≠ –®–∫–æ–ª–∞ –í–æ–ª—à–µ–±—Å—Ç–≤–∞ (–†–æ–ª–µ–≤–∞—è –ò–≥—Ä–∞)": {
        "description": "–ü–æ–ª–Ω–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ —Å—é–∂–µ—Ç. –õ–∞–≥–µ—Ä—å –∫–∞–∫ –¥–µ–∫–æ—Ä–∞—Ü–∏—è –∫ —Ñ–∏–ª—å–º—É.",
        "core": "–ò–≥—Ä–æ–≤–æ–µ (–≠–¥—å—é—Ç–µ–π–Ω–º–µ–Ω—Ç)",
        "engine": "–°—é–∂–µ—Ç–Ω–æ-–†–æ–ª–µ–≤–∞—è –ò–≥—Ä–∞ (RPG)"
    },
    "‚öíÔ∏è –†–µ—Å–ø—É–±–ª–∏–∫–∞ –®–ö–ò–î (–¢—Ä—É–¥ –∏ –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞)": {
        "description": "–°–∞–º–æ—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å. –ö–æ–ª–ª–µ–∫—Ç–∏–≤ –≤–æ—Å–ø–∏—Ç—ã–≤–∞–µ—Ç –ª–∏—á–Ω–æ—Å—Ç—å.",
        "core": "–ö–æ–ª–ª–µ–∫—Ç–∏–≤–∏—Å—Ç—Å–∫–æ–µ (–ú–∞–∫–∞—Ä–µ–Ω–∫–æ)",
        "engine": "–¢—Ä—É–¥ / –ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ"
    },
    "üåø –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ (–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ –ö–æ–º—Ñ–æ—Ä—Ç)": {
        "description": "–ì—É–º–∞–Ω–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥. –ü—Ä–∏–Ω—è—Ç–∏–µ, —Ä–µ—Ñ–ª–µ–∫—Å–∏—è, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≥–æ–Ω–∫–∏.",
        "core": "–ì—É–º–∞–Ω–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ (–†–æ–¥–∂–µ—Ä—Å)",
        "engine": "Soft Skills / –¢—Ä–µ–Ω–∏–Ω–≥"
    }
}

PRO_CORES = {
    "–õ–∏–¥–µ—Ä—Å–∫–æ–µ (–°–∫–∞—É—Ç–∏–Ω–≥ / –ë.–ü.)": "–¶–µ–Ω–Ω–æ—Å—Ç–∏: –•–∞—Ä–∞–∫—Ç–µ—Ä, –≤–æ–ª—è, —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å.",
    "–ö–æ–ª–ª–µ–∫—Ç–∏–≤–∏—Å—Ç—Å–∫–æ–µ (–ú–∞–∫–∞—Ä–µ–Ω–∫–æ)": "–¶–µ–Ω–Ω–æ—Å—Ç–∏: –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞.",
    "–ì—É–º–∞–Ω–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ (–†–æ–¥–∂–µ—Ä—Å)": "–¶–µ–Ω–Ω–æ—Å—Ç–∏: –õ–∏—á–Ω–æ—Å—Ç—å, —ç–º–æ—Ü–∏–∏, –ø—Ä–∏–Ω—è—Ç–∏–µ.",
    "–°–æ–∑–∏–¥–∞—Ç–µ–ª—å–Ω–æ–µ (–ò–≤–∞–Ω–æ–≤ / –ö–¢–î)": "–¶–µ–Ω–Ω–æ—Å—Ç–∏: –£–ª—É—á—à–µ–Ω–∏–µ –º–∏—Ä–∞, –∞–ª—å—Ç—Ä—É–∏–∑–º.",
    "–ò–≥—Ä–æ–≤–æ–µ (–≠–¥—å—é—Ç–µ–π–Ω–º–µ–Ω—Ç)": "–¶–µ–Ω–Ω–æ—Å—Ç–∏: –ò–Ω—Ç–µ—Ä–µ—Å, –ø–æ—Ç–æ–∫, —Ñ–∞–Ω—Ç–∞–∑–∏—è.",
    "–ü—Ä–æ–µ–∫—Ç–Ω–æ–µ (PBL / Dewey)": "–¶–µ–Ω–Ω–æ—Å—Ç–∏: –†–µ–∑—É–ª—å—Ç–∞—Ç, –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏."
}

PRO_ENGINES = {
    "Outdoor / –¢—É—Ä–∏–∑–º": "–ü–æ—Ö–æ–¥—ã, –∫–æ—Å—Ç—Ä—ã, –ø–∞–ª–∞—Ç–∫–∏.",
    "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ / –ê—Ä—Ç": "–°—Ü–µ–Ω–∞, –∫–æ–Ω—Ü–µ—Ä—Ç—ã, –¥–µ–∫–æ—Ä.",
    "–°—é–∂–µ—Ç–Ω–æ-–†–æ–ª–µ–≤–∞—è –ò–≥—Ä–∞ (RPG)": "–ö–≤–µ—Å—Ç—ã, –ø–µ—Ä—Å–æ–Ω–∞–∂–∏, –∑–∞–≥–∞–¥–∫–∏.",
    "–°–ø–æ—Ä—Ç / –¢–∞–∫—Ç–∏–∫–∞": "–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è, –∑–∞—Ä–Ω–∏—Ü—ã.",
    "Hard Skills / –ü—Ä–æ–µ–∫—Ç": "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –Ω–∞—É–∫–∞, —Ä–µ–º–µ—Å–ª–æ.",
    "Soft Skills / –¢—Ä–µ–Ω–∏–Ω–≥": "–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è."
}


# ==============================================================================
# I.a. –¶–ò–¢–ê–¢–´ –î–õ–Ø –≠–ö–†–ê–ù–ê –û–ñ–ò–î–ê–ù–ò–Ø (–ë–ï–ó –ü–û–î–ü–ò–°–ò ¬´–ù–ï–ô–†–û–°–ï–¢–¨¬ª)
# ==============================================================================


QUOTES = [
    "–í–æ—Å–ø–∏—Ç–∞–Ω–∏–µ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ö–æ—Ä–æ—à–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ –≤ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—É—é —á–∞—Å—Ç—å –∂–∏–∑–Ω–∏ —Ä–µ–±—ë–Ω–∫–∞.",
    "–õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± –≤—ã—Ä–∞—Å—Ç–∏—Ç—å —Ö–æ—Ä–æ—à–µ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ –ø–æ‚Äë–Ω–∞—Å—Ç–æ—è—â–µ–º—É —Å—á–∞—Å—Ç–ª–∏–≤—ã–º –≤ –¥–µ—Ç—Å—Ç–≤–µ.",
    "–î–µ—Ç—Å—Ç–≤–æ ‚Äî —á–∏—Å—Ç—ã–π –ª–∏—Å—Ç, –∞ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏–µ —Ä–µ—à–∞–µ—Ç, —Å—Ç–∞–Ω–µ—Ç –ª–∏ –Ω–∞ –Ω—ë–º –º—É–¥—Ä—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä —à—Ç—Ä–∏—Ö–æ–≤.",
    "–†–µ–±—ë–Ω–æ–∫ –≤–µ—Ä–∏—Ç –Ω–µ —Å–ª–æ–≤–∞–º –≤–∑—Ä–æ—Å–ª—ã—Ö, –∞ —Ç–æ–º—É, –∫–∞–∫ –æ–Ω–∏ –∂–∏–≤—É—Ç –º–µ–∂–¥—É —Å–æ–±–æ–π –∏ —Å –Ω–∏–º.",
    "–•–æ—Ä–æ—à–µ–µ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏–µ –¥–µ–ª–∞–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞ —Å–≤–æ–±–æ–¥–Ω—ã–º –æ—Ç –¥—É—Ä–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –ø–ª–æ—Ö–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π.",
    "–î–µ—Ç—è–º –Ω—É–∂–Ω–µ–µ –ø—Ä–∏–º–µ—Ä, —á–µ–º –ª–µ–∫—Ü–∏–∏: –æ–Ω–∏ –ø–æ–¥—Ä–∞–∂–∞—é—Ç –Ω–∞–º –≥–æ—Ä–∞–∑–¥–æ —Ä–∞–Ω—å—à–µ, —á–µ–º –Ω–∞—á–∏–Ω–∞—é—Ç –Ω–∞—Å —Å–ª—É—à–∞—Ç—å.",
    "–¢–æ—Ç, –∫—Ç–æ –∑–∞–±—ã–≤–∞–µ—Ç —Å–≤–æ—ë –¥–µ—Ç—Å—Ç–≤–æ, —Ä–µ–¥–∫–æ —É–º–µ–µ—Ç –ø–æ–Ω–∏–º–∞—Ç—å –¥–µ—Ç–µ–π –ø–æ‚Äë–Ω–∞—Å—Ç–æ—è—â–µ–º—É.",
    "–†–µ–±—ë–Ω–æ–∫ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –ª—é–±–≤–∏ –∏–º–µ–Ω–Ω–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ, –∫–∞–∫ –∫–∞–∂–µ—Ç—Å—è –≤–∑—Ä–æ—Å–ª—ã–º, –µ—ë –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç.",
    "–ï—Å–ª–∏ —Ä–µ–±—ë–Ω–æ–∫ –Ω–µ –ª—é–±–∏—Ç –≤–∑—Ä–æ—Å–ª–æ–≥–æ, —É —ç—Ç–æ–≥–æ –≤–∑—Ä–æ—Å–ª–æ–≥–æ –Ω–µ—Ç –º–æ—Ä–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–≤–∞ –µ–≥–æ –Ω–∞–∫–∞–∑—ã–≤–∞—Ç—å.",
    "–†–µ–±—ë–Ω–æ–∫ ‚Äî –∑–µ—Ä–∫–∞–ª–æ —Å–µ–º—å–∏: –≤ –Ω—ë–º –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –∏ —Å–∏–ª–∞, –∏ —Å–ª–∞–±–æ—Å—Ç—å —Å–µ—Ä–¥—Ü–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ–π.",
    "–ù–µ–ª—é–±–∏–º—ã–µ –¥–µ—Ç–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∑—Ä–æ—Å–ª—ã–º–∏, –∫–æ—Ç–æ—Ä—ã–º —Ç—Ä—É–¥–Ω–æ –ø–æ–≤–µ—Ä–∏—Ç—å –≤ –ª—é–±–æ–≤—å –∏ –ø–æ–¥–∞—Ä–∏—Ç—å –µ—ë –¥—Ä—É–≥–∏–º.",
    "–ö–æ–≥–¥–∞ —Ä–µ–±—ë–Ω–æ–∫ —á—É–≤—Å—Ç–≤—É–µ—Ç –∫ —Å–µ–±–µ –∏—Å–∫—Ä–µ–Ω–Ω—é—é, –±–µ—Å–∫–æ—Ä—ã—Å—Ç–Ω—É—é –ª—é–±–æ–≤—å, –æ–Ω —É—á–∏—Ç—Å—è –±—ã—Ç—å —Å—á–∞—Å—Ç–ª–∏–≤—ã–º –∏ —Å–º–µ–ª—ã–º.",
    "–û–±–µ—â–∞–Ω–∏–µ, –¥–∞–Ω–Ω–æ–µ —Ä–µ–±—ë–Ω–∫—É, —Å–≤—è—â–µ–Ω–Ω–µ–µ –¥–æ–≥–æ–≤–æ—Ä–∞: –Ω–∞—Ä—É—à–∏–≤ –µ–≥–æ, –≤–∑—Ä–æ—Å–ª—ã–π —Ä–∞–∑—Ä—É—à–∞–µ—Ç –¥–æ–≤–µ—Ä–∏–µ, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–æ.",
    "–ü—Ä–∏–≤—ã—á–∫–∞ –Ω–∏ –≤ —á—ë–º –Ω–µ –æ—Ç–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–±—ë–Ω–∫—É –¥–µ–ª–∞–µ—Ç –µ–≥–æ –Ω–µ—Å—á–∞—Å—Ç–Ω—ã–º –∑–∞–ª–æ–∂–Ω–∏–∫–æ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∂–µ–ª–∞–Ω–∏–π.",
    "–ù–∞—Å—Ç–æ—è—â–∞—è —Ü–µ–ª—å –≤–æ—Å–ø–∏—Ç–∞–Ω–∏—è ‚Äî –Ω–∞—É—á–∏—Ç—å –¥–µ—Ç–µ–π –æ–±—Ö–æ–¥–∏—Ç—å—Å—è –±–µ–∑ –Ω–∞—Å, –æ—Å—Ç–∞–≤–∞—è—Å—å —á–µ—Å—Ç–Ω—ã–º–∏ –∏ –¥–æ–±—Ä—ã–º–∏ –ª—é–¥—å–º–∏.",
    "–ù–∞—à–∏ –¥–µ—Ç–∏ ‚Äî —ç—Ç–æ –Ω–∞—à–µ –±—É–¥—É—â–µ–µ –∏ –Ω–∞—à –ø—Ä–∏–≥–æ–≤–æ—Ä: –æ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏—è –∑–∞–≤–∏—Å–∏—Ç –Ω–∞—à–∞ –∑–∞–≤—Ç—Ä–∞—à–Ω—è—è —Å—Ç–∞—Ä–æ—Å—Ç—å.",
    "–û–¥–∏–Ω –ª—é–±—è—â–∏–π –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–æ–¥–∏—Ç–µ–ª—å –∑–Ω–∞—á–∏—Ç –±–æ–ª—å—à–µ, —á–µ–º –¥–µ—Å—è—Ç–∫–∏ —Å–∞–º—ã—Ö —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã—Ö —É—á–∏—Ç–µ–ª–µ–π.",
    "–°–µ–º—å—è ‚Äî –ø–µ—Ä–≤–∞—è —à–∫–æ–ª–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã, —É–≤–∞–∂–µ–Ω–∏—è –∏ –ª—é–±–≤–∏; –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç, –¥—Ä—É–≥–∏–º –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞–º –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–æ–≥–æ–Ω—è—Ç—å.",
    "–ë–∞–ª–æ–≤–∞—Ç—å —Ä–µ–±—ë–Ω–∫–∞ –ø—Ä–æ—â–µ, —á–µ–º –≤–æ—Å–ø–∏—Ç—ã–≤–∞—Ç—å, –Ω–æ –ø–ª–∞—Ç–∏—Ç—å –∑–∞ —ç—Ç–æ –ø—Ä–∏–¥—ë—Ç—Å—è –∏ –µ–º—É, –∏ –≤–∑—Ä–æ—Å–ª—ã–º.",
    "–í–æ—Å–ø–∏—Ç–∞–Ω–∏–µ —Ä–µ–±—ë–Ω–∫–∞ ‚Äî —ç—Ç–æ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞–¥ —Å–æ–±–æ–π: –æ–Ω —É—á–∏—Ç—Å—è —É –Ω–∞—Å, –∞ –º—ã —É—á–∏–º—Å—è —É –Ω–µ–≥–æ.",
]


# ==============================================================================
# II. –®–ê–ë–õ–û–ù–´ –†–ê–°–ü–ò–°–ê–ù–ò–Ø –ò –î–ò–ù–ê–ú–ò–ö–ê
# ==============================================================================


def get_day_template(day_num, total_days):
    if day_num == 1:
        return {
            "type": "arrival",
            "slots": [
                {"time": "12:00-12:40", "fixed": "–ó–∞–µ–∑–¥, –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ, –ø—Ä–∞–≤–∏–ª–∞."},
                {"time": "12:40-13:00", "fixed": "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –æ—Ç—Ä—è–¥–∞–º."},
                {"time": "13:00-14:00", "fixed": "–†–∞—Å—Å–µ–ª–µ–Ω–∏–µ, —ç–∫—Å–∫—É—Ä—Å–∏—è, –ø–∞–ª–∞—Ç–∫–∏."},
                {"time": "14:00-15:00", "fixed": "–û–±–µ–¥."},
                {"time": "15:00-17:30", "ai_key": "team_building_games", "desc": "–ò–≥—Ä—ã –Ω–∞ –∫–æ–º–∞–Ω–¥–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"},
                {"time": "17:30-18:00", "fixed": "–û—Ç—Ä—è–¥–Ω–æ–µ –≤—Ä–µ–º—è."},
                {"time": "18:00-18:30", "fixed": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –≤–µ—á–µ—Ä–Ω–µ–º—É –¥–µ–ª—É."},
                {"time": "18:30-19:00", "fixed": "–°–æ–∑–≤–æ–Ω —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏."},
                {"time": "19:00-20:00", "fixed": "–£–∂–∏–Ω."},
                {"time": "20:00-21:00", "ai_key": "evening_event", "desc": "–í–µ—á–µ—Ä–Ω–µ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ"},
                {"time": "21:00-22:00", "ai_key": "candle", "desc": "–í–µ—á–µ—Ä–Ω—è—è —Å–≤–µ—á–∫–∞ / –ö–æ—Å—Ç–µ—Ä"},
                {"time": "22:00-22:30", "fixed": "–í–µ—á–µ—Ä–Ω—è—è –≥–∏–≥–∏–µ–Ω–∞."},
                {"time": "22:30", "fixed": "–û—Ç–±–æ–π."}
            ]
        }
    elif day_num == total_days:
        return {
            "type": "departure",
            "slots": [
                {"time": "08:00", "fixed": "–ü–æ–¥—ä–µ–º."},
                {"time": "08:00-08:30", "fixed": "–£—Ç—Ä–µ–Ω–Ω–∏–π —Ç—É–∞–ª–µ—Ç (–≥–∏–≥–∏–µ–Ω–∞, —Å–º–µ–Ω–∞ –±–µ–ª—å—è)."},
                {"time": "08:30-09:00", "fixed": "–ó–∞—Ä—è–¥–∫–∞."},
                {"time": "09:00-09:30", "fixed": "–ó–∞–≤—Ç—Ä–∞–∫."},
                {"time": "09:30-10:00", "fixed": "–û–±—â–∏–π —Å–±–æ—Ä."},
                {"time": "10:00-11:00", "fixed": "–°–±–æ—Ä –≤–µ—â–µ–π –∏ –ø–∞–ª–∞—Ç–æ–∫."},
                {"time": "11:00-12:00", "fixed": "–£–±–æ—Ä–∫–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏, —Å–¥–∞—á–∞ –æ–±—ä–µ–∫—Ç–æ–≤."},
                {"time": "12:00-13:00", "fixed": "–û–ø–µ—Ä–∞—Ü–∏—è '–°–ø–∞—Å–∏–±–∫–∏'."},
                {"time": "13:00-13:30", "fixed": "–ê—É–∫—Ü–∏–æ–Ω –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –≤–µ—â–µ–π."},
                {"time": "13:30-14:30", "fixed": "–û–±–µ–¥."},
                {"time": "14:30", "fixed": "–û—Ç—ä–µ–∑–¥."}
            ]
        }
    else:
        skill_complexity = "–ë–∞–∑–æ–≤—ã–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ—Å—Ç–µ—Ä)"
        if day_num > total_days / 2:
            skill_complexity = "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π (—É–∑–ª—ã, —É–∫—Ä—ã—Ç–∏—è)"
        if day_num == total_days - 1:
            skill_complexity = "–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π (–ø–µ—Ä–≤–∞—è –ø–æ–º–æ—â—å, —Å–ø–∞—Å—Ä–∞–±–æ—Ç—ã)"

        return {
            "type": "standard",
            "forest_hint": skill_complexity,
            "slots": [
                {"time": "08:00", "fixed": "–ü–æ–¥—ä–µ–º."},
                {"time": "08:00-08:30", "fixed": "–£—Ç—Ä–µ–Ω–Ω–∏–π —Ç—É–∞–ª–µ—Ç (—Å–º–µ–Ω–∞ –±–µ–ª—å—è/–Ω–æ—Å–∫–æ–≤, –∑—É–±—ã)."},
                {"time": "08:30-09:00", "fixed": "–ó–∞—Ä—è–¥–∫–∞."},
                {"time": "09:00-09:30", "fixed": "–ó–∞–≤—Ç—Ä–∞–∫."},
                {"time": "09:30-10:00", "fixed": "–û–±—â–∏–π —Å–±–æ—Ä (–ø–æ–≤–µ—Ä–∫–∞, —Ç–µ–º–∞ –¥–Ω—è)."},
                {"time": "10:00-10:30", "ai_key": "sense_block", "desc": "–°–º—ã—Å–ª–æ–≤–æ–π –±–ª–æ–∫/–£—Ä–æ–∫"},
                {"time": "10:30-11:00", "ai_key": "practice_block", "desc": "–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —É—Ä–æ–∫–∞ (–∏–≥—Ä–∞)"},
                {"time": "11:00-12:00", "ai_key": "forest_skill", "desc": f"–õ–µ—Å–Ω–æ–π –Ω–∞–≤—ã–∫ ({skill_complexity})"},
                {"time": "12:00-13:30", "ai_key": "sport_activity", "desc": "–°–ø–æ—Ä—Ç / –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"},
                {"time": "13:30-14:00", "fixed": "–ì–∏–≥–∏–µ–Ω–∞."},
                {"time": "14:00-15:00", "fixed": "–û–±–µ–¥."},
                {"time": "15:00-16:00", "ai_key": "quiet_activity", "desc": "–¢–∏—Ö–∏–π —á–∞—Å / –ë–æ—Ç–∞–Ω–∏–∫–∞"},
                {"time": "16:00-17:00", "ai_key": "workshop", "desc": "–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è + –¢—É—Ä.–±—ã—Ç"},
                {"time": "17:00-17:30", "ai_key": "games_age", "desc": "–ò–≥—Ä—ã (—Å–º–µ–Ω–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)"},
                {"time": "17:30-18:00", "fixed": "–û—Ç—Ä—è–¥–Ω–æ–µ –≤—Ä–µ–º—è (—Ä–µ—Ñ–ª–µ–∫—Å–∏—è)."},
                {"time": "18:00-18:30", "fixed": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –≤–µ—á–µ—Ä—É."},
                {"time": "18:30-19:00", "fixed": "–°–æ–∑–≤–æ–Ω —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏."},
                {"time": "19:00-20:00", "fixed": "–£–∂–∏–Ω."},
                {"time": "20:00-21:00", "ai_key": "evening_event", "desc": "–í–µ—á–µ—Ä–Ω–µ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ"},
                {"time": "21:00-22:00", "ai_key": "candle", "desc": "–í–µ—á–µ—Ä–Ω—è—è —Å–≤–µ—á–∫–∞ / –ö–æ—Å—Ç–µ—Ä"},
                {"time": "22:00-22:30", "fixed": "–í–µ—á–µ—Ä–Ω—è—è –≥–∏–≥–∏–µ–Ω–∞."},
                {"time": "22:30", "fixed": "–û—Ç–±–æ–π."}
            ]
        }


def get_group_dynamics(day: int, total_days: int) -> Dict[str, str]:
    progress = day / total_days
    if day == 1:
        return {"Stage": "–ó–ù–ê–ö–û–ú–°–¢–í–û", "Task": "–°–Ω—è—Ç—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è."}
    if progress <= 0.25:
        return {"Stage": "–ü–†–ò–¢–ò–†–ö–ê", "Task": "–ù–æ—Ä–º—ã –∏ –ø—Ä–∞–≤–∏–ª–∞."}
    elif 0.25 < progress <= 0.45:
        return {"Stage": "–ö–û–ù–§–õ–ò–ö–¢", "Task": "–£–º–µ–Ω–∏–µ –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å—Å—è."}
    elif 0.45 < progress <= 0.85:
        return {"Stage": "–†–ê–ë–û–¢–ê", "Task": "–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å."}
    else:
        return {"Stage": "–§–ò–ù–ê–õ", "Task": "–§–∏–∫—Å–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞."}


# ==============================================================================
# III. JSON-–£–¢–ò–õ–ò–¢–´ –ò –†–ï–ú–û–ù–¢ "–ü–û–ß–¢–ò JSON"
# ==============================================================================


def extract_and_clean_json(text: str) -> str:
    if not text:
        return ""
    t = text.strip()
    t = t.replace("``````", "").strip()
    start_match = re.search(r'[\[\{]', t)
    if not start_match:
        return t
    start_idx = start_match.start()
    end_idx_brace = t.rfind("}")
    end_idx_bracket = t.rfind("]")
    end_idx = max(end_idx_brace, end_idx_bracket)
    if end_idx == -1:
        return t[start_idx:]
    return t[start_idx : end_idx + 1]


def repair_almost_json(s: str) -> str:
    if not s:
        return s
    last_brace = s.rfind("}")
    last_bracket = s.rfind("]")
    cut = max(last_brace, last_bracket)
    if cut != -1:
        s = s[: cut + 1]
    s = "".join(ch for ch in s if ord(ch) >= 32 or ch in "\n\t")
    return s


def safe_json_loads(raw: str) -> Any:
    try:
        return json.loads(raw)
    except Exception:
        fixed = repair_almost_json(raw)
        return json.loads(fixed)


def smart_find_key(data: Any, target_key: str) -> Union[Dict, None]:
    if isinstance(data, dict):
        if target_key in data:
            return data[target_key]
        for _, value in data.items():
            result = smart_find_key(value, target_key)
            if result:
                return result
    elif isinstance(data, list):
        for item in data:
            result = smart_find_key(item, target_key)
            if result:
                return result
    return None


# ==============================================================================
# IV. LLM-–ö–õ–ò–ï–ù–¢ (Llama 3.1 8B —á–µ—Ä–µ–∑ LM Studio)
# ==============================================================================


def call_local_llm(user_prompt: str, temperature: float, system_prompt: str, settings: Dict[str, Any]) -> Union[str, None]:
    base_url = "http://192.168.1.123:1234/v1/chat/completions"
    model = settings.get("model_name", "meta-llama-3.1-8b-instruct-hf")
    max_tokens = settings.get("max_tokens", 768)

    try:
        payload = {
            "model": model,
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt},
            ],
            "temperature": float(temperature),
            "max_tokens": int(max_tokens),
            "stream": False,
        }

        resp = requests.post(base_url, json=payload, timeout=120)
        resp.raise_for_status()
        data = resp.json()
        text = data["choices"][0]["message"]["content"]
        return text

    except Exception as e:
        log_error(f"–°–±–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (local Llama): {e}")
        return None


def get_current_methodology_desc() -> str:
    s = st.session_state.settings
    if s.get("mode_selection") == "Lite (–ü—Ä–µ—Å–µ—Ç—ã)":
        preset_name = s.get("preset_name", list(PRESETS.keys())[0])
        preset = PRESETS.get(preset_name, list(PRESETS.values())[0])
        return f"–§–ò–õ–û–°–û–§–ò–Ø: {preset['core']}\n–î–ï–Ø–¢–ï–õ–¨–ù–û–°–¢–¨: {preset['engine']}"
    else:
        return f"–§–ò–õ–û–°–û–§–ò–Ø: {s.get('pro_core')}\n–î–ï–Ø–¢–ï–õ–¨–ù–û–°–¢–¨: {s.get('pro_engine')}"


# ==============================================================================
# V. –ö–û–ù–í–ï–ô–ï–† –ö–û–ù–¶–ï–ü–¶–ò–ô –° –¶–ò–¢–ê–¢–ê–ú–ò –ò –ó–ê–©–ò–¢–û–ô
# ==============================================================================


def generate_concepts_pipeline():
    settings = st.session_state.settings
    methodology = get_current_methodology_desc()
    brief_idea = st.session_state.get("brief_idea", "").strip()
    temperature = settings.get("temperature", 0.7)

    quote_placeholder = st.empty()

    def show_quote(idx: int):
        if not QUOTES:
            return
        q = QUOTES[idx % len(QUOTES)]
        quote_placeholder.markdown(f"> {q}")

    # ---------- –®–ê–ì 1. –ö–†–ê–¢–ö–ò–ï –ò–î–ï–ò ----------
    system_prompt_ideas = f"""
–¢—ã ‚Äî –ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –ú–µ—Ç–æ–¥–∏—Å—Ç –¥–µ—Ç—Å–∫–æ–≥–æ –ø–∞–ª–∞—Ç–æ—á–Ω–æ–≥–æ –ª–∞–≥–µ—Ä—è.
–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–¥—É–º–∞–π –¢–û–õ–¨–ö–û 3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏–¥–µ–∏ —Å–º–µ–Ω—ã.

–ú–ï–¢–û–î–ò–ö–ê:
{methodology}

–û—Ç–≤–µ—Ç —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ò–°–¢–û–ì–û JSON.

–§–æ—Ä–º–∞—Ç:
[
  {{
    "–ö—Ä–∞—Ç–∫–æ–µ_–ù–∞–∑–≤–∞–Ω–∏–µ": "–æ—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–º–µ–Ω—ã",
    "–ö—Ä–∞—Ç–∫–∞—è_–ò–¥–µ—è": "2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –æ —á–µ–º —ç—Ç–∞ —Å–º–µ–Ω–∞"
  }},
  ...
]

–ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ JSON.
–Ø–ó–´–ö: –†–£–°–°–ö–ò–ô.
"""

    base = f"–ù–∞–∑–≤–∞–Ω–∏–µ —Å–º–µ–Ω—ã: {st.session_state.project_title}. –í–æ–∑—Ä–∞—Å—Ç: {st.session_state.age_group}. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {st.session_state.duration_days} –¥–Ω–µ–π."
    if brief_idea:
        user_prompt_ideas = base + f" –ß–µ—Ä–Ω–æ–≤–∞—è –∏–¥–µ—è —Å–º–µ–Ω—ã: {brief_idea}"
    else:
        user_prompt_ideas = base

    show_quote(0)
    with st.spinner("‚ú® Llama –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–¥–µ–π..."):
        res_ideas = call_local_llm(user_prompt_ideas, temperature, system_prompt_ideas, settings)

    if not res_ideas:
        quote_placeholder.empty()
        return

    try:
        cleaned_ideas = extract_and_clean_json(res_ideas)
        ideas_raw = safe_json_loads(cleaned_ideas)
        ideas_list = [x for x in ideas_raw if isinstance(x, dict)]
        if not ideas_list:
            raise ValueError("–°–ø–∏—Å–æ–∫ –∏–¥–µ–π –ø—É—Å—Ç –∏–ª–∏ –±–µ–∑ —Å–ª–æ–≤–∞—Ä–µ–π")
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–ø–∏—Å–∫–∞ –∏–¥–µ–π: {e}")
        st.session_state.concepts_list = [
            {
                "–ù–∞–∑–≤–∞–Ω–∏–µ": "–ß–µ—Ä–Ω–æ–≤–∞—è –∏–¥–µ—è —Å–º–µ–Ω—ã",
                "–ò–¥–µ—è": extract_and_clean_json(res_ideas),
                "–•–æ–¥_–°–º–µ–Ω—ã": "–ú–æ–¥–µ–ª—å –Ω–µ —Å–º–æ–≥–ª–∞ –≤—ã–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å.",
                "–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ_–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏": "",
                "–†–µ–∑—É–ª—å—Ç–∞—Ç_–†–µ–±–µ–Ω–∫–∞": "",
            }
        ]
        st.session_state.step = 2
        quote_placeholder.empty()
        st.rerun()
        return

    ideas_list = ideas_list[:3]

    # ---------- –®–ê–ì 2. –†–ê–°–®–ò–†–ï–ù–ò–ï –ö–ê–ñ–î–û–ô –ò–î–ï–ò ----------
    full_concepts = []
    for idx, idea in enumerate(ideas_list):
        short_title = idea.get("–ö—Ä–∞—Ç–∫–æ–µ_–ù–∞–∑–≤–∞–Ω–∏–µ", f"–í–∞—Ä–∏–∞–Ω—Ç {idx+1}")
        short_idea = idea.get("–ö—Ä–∞—Ç–∫–∞—è_–ò–¥–µ—è", "")

        system_prompt_full = f"""
–¢—ã ‚Äî –ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –ú–µ—Ç–æ–¥–∏—Å—Ç –¥–µ—Ç—Å–∫–æ–≥–æ –ª–∞–≥–µ—Ä—è.
–í–æ–∑—å–º–∏ –∫—Ä–∞—Ç–∫—É—é –∏–¥–µ—é —Å–º–µ–Ω—ã –∏ —Å–¥–µ–ª–∞–π –∏–∑ –Ω–µ—ë –ø–æ–ª–Ω—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é.

–ú–ï–¢–û–î–ò–ö–ê:
{methodology}

–ö—Ä–∞—Ç–∫–∞—è –∏–¥–µ—è:
–ù–∞–∑–≤–∞–Ω–∏–µ: {short_title}
–û–ø–∏—Å–∞–Ω–∏–µ: {short_idea}

–û—Ç–≤–µ—Ç —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ò–°–¢–û–ì–û JSON-–æ–±—ä–µ–∫—Ç–∞.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
{{
  "–ù–∞–∑–≤–∞–Ω–∏–µ": "—É—Ç–æ—á–Ω–µ–Ω–Ω–æ–µ, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–º–µ–Ω—ã",
  "–ò–¥–µ—è": "2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –æ —á–µ–º —Å–º–µ–Ω–∞ –∏ –≤ —á–µ–º –µ—ë —Ñ–∏—à–∫–∞",
  "–•–æ–¥_–°–º–µ–Ω—ã": "2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: —Å –∫–∞–∫–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ç–æ—á–∫–∏ —Å—Ç–∞—Ä—Ç—É–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫ (–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø—Ä–∏–≤—ã—á–∫–∏, –ø—Ä–æ–±–ª–µ–º—ã), –ø–æ –∫–∞–∫–æ–º—É –ø—Ä–∏–Ω—Ü–∏–ø—É –∏ —á–µ—Ä–µ–∑ –∫–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è –æ–Ω –±—É–¥–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ, –∏ –∫ –∫–∞–∫–æ–º—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º –≤—ã–≤–æ–¥–∞–º –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É —Å–º–µ–Ω—ã (–±–µ–∑ –ø–æ–∫–∞–¥—Ä–æ–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ –¥–Ω—è–º).",
  "–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ_–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏": "2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∫–∞–∫ –∏–º–µ–Ω–Ω–æ –≤–æ—Å–ø–∏—Ç—ã–≤–∞–µ–º –∏ –æ–±—É—á–∞–µ–º, —á–µ—Ä–µ–∑ –∫–∞–∫–∏–µ —Ñ–æ—Ä–º—ã —Ä–∞–±–æ—Ç—ã",
  "–†–µ–∑—É–ª—å—Ç–∞—Ç_–†–µ–±–µ–Ω–∫–∞": "2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∫–∞–∫–∏–º —Ä–µ–±—ë–Ω–æ–∫ —É–µ–∑–∂–∞–µ—Ç –¥–æ–º–æ–π (—É–º–µ–Ω–∏—è, –∫–∞—á–µ—Å—Ç–≤–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è)"
}}

–ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ JSON.
–Ø–ó–´–ö: –†–£–°–°–ö–ò–ô.
"""

        user_prompt_full = f"–í–æ–∑—Ä–∞—Å—Ç: {st.session_state.age_group}. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {st.session_state.duration_days} –¥–Ω–µ–π."

        show_quote(idx + 1)
        with st.spinner(f"üß© Llama —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –∏–¥–µ—é {idx+1} –∏–∑ {len(ideas_list)}..."):
            res_full = call_local_llm(user_prompt_full, temperature, system_prompt_full, settings)

        if not res_full:
            continue

        try:
            cleaned_full = extract_and_clean_json(res_full)
            concept = safe_json_loads(cleaned_full)
            if isinstance(concept, dict):
                full_concepts.append(concept)
            else:
                raise ValueError("–ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ –æ–±—ä–µ–∫—Ç")
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ {idx+1}: {e}")
            full_concepts.append(
                {
                    "–ù–∞–∑–≤–∞–Ω–∏–µ": short_title,
                    "–ò–¥–µ—è": short_idea,
                    "–•–æ–¥_–°–º–µ–Ω—ã": extract_and_clean_json(res_full),
                    "–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ_–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏": "",
                    "–†–µ–∑—É–ª—å—Ç–∞—Ç_–†–µ–±–µ–Ω–∫–∞": "",
                }
            )

    quote_placeholder.empty()

    if not full_concepts:
        log_error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–π –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏.")
        return

    st.session_state.concepts_list = full_concepts
    st.session_state.step = 2
    st.rerun()


# ==============================================================================
# VI. ROADMAP –ò –†–ê–°–ü–ò–°–ê–ù–ò–ï
# ==============================================================================


def generate_roadmap():
    settings = st.session_state.settings
    days = st.session_state.duration_days
    concept = st.session_state.selected_concept or {}
    dyn_info = "\n".join(
        [f"–î–µ–Ω—å {d}: {get_group_dynamics(d, days)['Stage']}" for d in range(1, days + 1)]
    )
    temperature = settings.get("temperature", 0.5)

    system_prompt = f"""
–¢—ã ‚Äî –ú–µ—Ç–æ–¥–∏—Å—Ç –õ–∞–≥–µ—Ä—è. –°–æ–∑–¥–∞–π –ª–æ–≥–∏–∫—É —Å–º–µ–Ω—ã (Roadmap) –ø–æ –¥–Ω—è–º.

–ö–û–ù–¶–ï–ü–¶–ò–Ø:
–ù–∞–∑–≤–∞–Ω–∏–µ: {concept.get('–ù–∞–∑–≤–∞–Ω–∏–µ', '')}
–ò–¥–µ—è: {concept.get('–ò–¥–µ—è', '')}

–î–ò–ù–ê–ú–ò–ö–ê –û–¢–†–Ø–î–ê –ü–û –î–ù–Ø–ú:
{dyn_info}

–û—Ç–≤–µ—Ç —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ò–°–¢–û–ì–û JSON.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
[
  {{
    "–î–µ–Ω—å": 1,
    "–¢–µ–º–∞_–î–Ω—è": "–æ–¥–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ",
    "–¶–µ–ª—å_–î–Ω—è": "1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è",
    "–ö–ª—é—á–µ–≤–æ–π_–ù–∞–≤—ã–∫": "–æ–¥–Ω–æ —Å–ª–æ–≤–æ—Å–æ—á–µ—Ç–∞–Ω–∏–µ"
  }},
  ...
]

–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON. –Ø–ó–´–ö: –†–£–°–°–ö–ò–ô.
"""

    with st.spinner("üó∫Ô∏è Llama —Å—Ç—Ä–æ–∏—Ç –∫–∞—Ä—Ç—É —Å–º–µ–Ω—ã..."):
        res = call_local_llm("–°–æ—Å—Ç–∞–≤—å Roadmap –ø–æ –¥–Ω—è–º.", temperature, system_prompt, settings)
    if not res:
        return

    try:
        cleaned = extract_and_clean_json(res)
        data = safe_json_loads(cleaned)
        if isinstance(data, list):
            st.session_state.roadmap = data
        else:
            raise ValueError("–ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ –º–∞—Å—Å–∏–≤ –¥–Ω–µ–π")
        st.session_state.step = 3
        st.rerun()
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ JSON Roadmap: {e}")
        st.session_state.roadmap = [
            {"–î–µ–Ω—å": i + 1, "–¢–µ–º–∞_–î–Ω—è": f"–î–µ–Ω—å {i+1}", "–¶–µ–ª—å_–î–Ω—è": "", "–ö–ª—é—á–µ–≤–æ–π_–ù–∞–≤—ã–∫": ""}
            for i in range(days)
        ]
        st.session_state.step = 3
        st.rerun()


def generate_day_schedule(day_data):
    settings = st.session_state.settings
    day_num = day_data.get("–î–µ–Ω—å", 1)
    total_days = st.session_state.duration_days
    concept = st.session_state.selected_concept or {}
    temperature = settings.get("temperature", 0.5)

    template = get_day_template(day_num, total_days)

    # –î–µ–Ω—å –æ—Ç—ä–µ–∑–¥–∞ ‚Äî —Ç–æ–ª—å–∫–æ —Ñ–∏–∫—Å-—Å–ª–æ—Ç—ã
    if template["type"] == "departure":
        if "schedule_by_day" not in st.session_state:
            st.session_state.schedule_by_day = {}
        st.session_state.schedule_by_day[day_num] = template["slots"]
        st.rerun()
        return

    # –ï—Å–ª–∏ –Ω–µ—Ç —Å–ª–æ—Ç–æ–≤ –¥–ª—è –ò–ò ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —à–∞–±–ª–æ–Ω
    ai_keys = [slot for slot in template["slots"] if "ai_key" in slot]
    if not ai_keys:
        if "schedule_by_day" not in st.session_state:
            st.session_state.schedule_by_day = {}
        st.session_state.schedule_by_day[day_num] = template["slots"]
        st.rerun()
        return

    forest_hint = template.get("forest_hint", "")
    keys_list = ", ".join([k["ai_key"] for k in ai_keys])

    # –î–∏–Ω–∞–º–∏–∫–∞ –≥—Ä—É–ø–ø—ã
    stage_info = get_group_dynamics(day_num, total_days)
    stage = stage_info["Stage"]
    stage_task = stage_info["Task"]

    # –í–æ–∑—Ä–∞—Å—Ç –∏ –≤–µ–¥—É—â–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ –≠–ª—å–∫–æ–Ω–∏–Ω—É
    age_group = st.session_state.age_group

    system_prompt = f"""
–¢—ã ‚Äî –ú–µ—Ç–æ–¥–∏—Å—Ç –õ–∞–≥–µ—Ä—è. –ó–∞–ø–æ–ª–Ω–∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –æ–¥–∏–Ω –¥–µ–Ω—å.
–Ø–ó–´–ö: –†–£–°–°–ö–ò–ô.

–ö–û–ù–¶–ï–ü–¶–ò–Ø:
–ù–∞–∑–≤–∞–Ω–∏–µ: {concept.get('–ù–∞–∑–≤–∞–Ω–∏–µ', '')}
–ò–¥–µ—è: {concept.get('–ò–¥–µ—è', '')}

–°–¢–ê–î–ò–Ø –ì–†–£–ü–ü–´: {stage}.
–ó–ê–î–ê–ß–ê –°–¢–ê–î–ò–ò: {stage_task}.

–í–û–ó–†–ê–°–¢ –£–ß–ê–°–¢–ù–ò–ö–û–í: {age_group}.
–£–ß–ò–¢–´–í–ê–ô –í–ï–î–£–©–£–Æ –î–ï–Ø–¢–ï–õ–¨–ù–û–°–¢–¨ –ü–û –≠–õ–¨–ö–û–ù–ò–ù–£ –ò –û–°–û–ë–ï–ù–ù–û–°–¢–ò –í–û–ó–†–ê–°–¢–ê:
- –¥–ª—è –º–ª–∞–¥—à–µ–≥–æ —à–∫–æ–ª—å–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞: –∫–æ—Ä–æ—Ç–∫–∏–µ –±–ª–æ–∫–∏, —á–∞—Å—Ç–∞—è —Å–º–µ–Ω–∞ –≤–∏–¥–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –º–Ω–æ–≥–æ –∏–≥—Ä—ã, –¥–≤–∏–∂–µ–Ω–∏—è –∏ –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏;
- –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞: –±–∞–ª–∞–Ω—Å –∏–≥—Ä—ã, —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π –∏ —É—á–µ–±–Ω–æ-–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á, –∑–∞–¥–∞–Ω–∏—è –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ;
- –¥–ª—è —Å—Ç–∞—Ä—à–µ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞: –±–æ–ª—å—à–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–π, –ø—Ä–æ–µ–∫—Ç–æ–≤, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏.
–ü–æ–¥–±–∏—Ä–∞–π —Ñ–æ—Ä–º—É –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã –∏ —Ä–∞–∑–≤–∏–≤–∞—é—â–∏ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞.

–î–ï–ù–¨ {day_num}: –¢–µ–º–∞ –¥–Ω—è "{day_data.get('–¢–µ–º–∞_–î–Ω—è', '')}".
–õ–ï–°–ù–û–ô –ù–ê–í–´–ö (—Å–ª–æ–∂–Ω–æ—Å—Ç—å): {forest_hint}

–ù—É–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –∫–ª—é—á–µ–π: {keys_list}.

–û—Ç–≤–µ—Ç —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ò–°–¢–û–ì–û JSON-–æ–±—ä–µ–∫—Ç–∞.

–§–æ—Ä–º–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞:
{{
  "<ai_key>": {{
    "–ù–∞–∑–≤–∞–Ω–∏–µ": "–∫—Ä–∞—Ç–∫–æ",
    "–¶–µ–ª—å": "1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è",
    "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": "—Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é",
    "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è": "–∫—Ä–∞—Ç–∫–∞—è –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç": "1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ"
  }}
}}

–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON. –ï—Å–ª–∏ –∫–∞–∫–æ–≥–æ-—Ç–æ –∫–ª—é—á–∞ –Ω–µ—Ç –≤ –¥–Ω–µ, –µ–≥–æ –º–æ–∂–Ω–æ –æ–ø—É—Å—Ç–∏—Ç—å.
"""

    with st.spinner(f"üìÖ Llama –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –î–µ–Ω—å {day_num}..."):
        res = call_local_llm("–ó–∞–ø–æ–ª–Ω–∏ –±–ª–æ–∫–∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏.", temperature, system_prompt, settings)
    if not res:
        return

    try:
        cleaned = extract_and_clean_json(res)
        ai_content = safe_json_loads(cleaned)

        final_slots = []
        for slot in template["slots"]:
            if "fixed" in slot:
                final_slots.append(slot)
            elif "ai_key" in slot:
                key = slot["ai_key"]
                raw_data = smart_find_key(ai_content, key)
                if not raw_data or not isinstance(raw_data, (dict, str)):
                    raw_data = {
                        "–ù–∞–∑–≤–∞–Ω–∏–µ": "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏",
                        "–¶–µ–ª—å": "-",
                        "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": "-",
                        "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è": "–ú–æ–¥–µ–ª—å –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ —ç—Ç–æ—Ç –±–ª–æ–∫",
                        "–†–µ–∑—É–ª—å—Ç–∞—Ç": "-",
                    }
                elif isinstance(raw_data, str):
                    raw_data = {
                        "–ù–∞–∑–≤–∞–Ω–∏–µ": raw_data,
                        "–¶–µ–ª—å": "-",
                        "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": "-",
                        "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è": "-",
                        "–†–µ–∑—É–ª—å—Ç–∞—Ç": "-",
                    }

                final_slots.append(
                    {
                        "time": slot["time"],
                        "type": "ai",
                        "data": raw_data,
                    }
                )

        if "schedule_by_day" not in st.session_state:
            st.session_state.schedule_by_day = {}
        st.session_state.schedule_by_day[day_num] = final_slots
        st.rerun()
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –¥–Ω—è: {e}")
        if "schedule_by_day" not in st.session_state:
            st.session_state.schedule_by_day = {}
        st.session_state.schedule_by_day[day_num] = [
            s for s in template["slots"] if "fixed" in s
        ]
        st.rerun()


# ==============================================================================
# VII. UI (STREAMLIT)
# ==============================================================================


def init_session_state():
    if "initialized" not in st.session_state:
        st.session_state.initialized = True
        st.session_state.step = 1
        st.session_state.project_title = "–õ–µ—Å–Ω–∞—è –°–∫–∞–∑–∫–∞"
        st.session_state.age_group = "9-11 –ª–µ—Ç"
        st.session_state.duration_days = 5
        st.session_state.brief_idea = ""
        st.session_state.concepts_list = []
        st.session_state.selected_concept = None
        st.session_state.user_supplement = ""
        st.session_state.roadmap = []
        st.session_state.schedule_by_day = {}
        st.session_state.debug_logs = []

        st.session_state.settings = {
            "model_name": "meta-llama-3.1-8b-instruct-hf",
            "max_tokens": 768,
            "temperature": 0.7,
            "mode_selection": "Lite (–ü—Ä–µ—Å–µ—Ç—ã)",
            "preset_name": list(PRESETS.keys())[0],
            "pro_core": list(PRO_CORES.keys())[0],
            "pro_engine": list(PRO_ENGINES.keys())[0],
        }


def main():
    st.set_page_config(layout="wide", page_title="Camp AI (Local Llama 3.1 8B)")
    init_session_state()

    # –°–∞–π–¥–±–∞—Ä
    with st.sidebar:
        st.title("‚öôÔ∏è Llama 3.1 8B (–ª–æ–∫–∞–ª—å–Ω–æ)")

        st.session_state.settings["model_name"] = st.text_input(
            "Model Name (LM Studio)", st.session_state.settings["model_name"]
        )

        st.session_state.settings["max_tokens"] = st.number_input(
            "Max tokens (–æ—Ç–≤–µ—Ç)",
            min_value=256,
            max_value=2048,
            value=st.session_state.settings["max_tokens"],
            step=128,
        )

        st.session_state.settings["temperature"] = st.slider(
            "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å (temperature)",
            min_value=0.1,
            max_value=1.0,
            value=st.session_state.settings["temperature"],
            step=0.05,
            help="–ú–µ–Ω—å—à–µ ‚Äî —Å—Ç—Ä–æ–∂–µ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–µ–µ, –±–æ–ª—å—à–µ ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω–µ–µ.",
        )

        st.markdown("---")
        mode = st.radio(
            "–†–µ–∂–∏–º –º–µ—Ç–æ–¥–∏–∫–∏:", ["Lite (–ü—Ä–µ—Å–µ—Ç—ã)", "Pro (–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä)"], key="mode_radio"
        )
        st.session_state.settings["mode_selection"] = mode
        if mode == "Lite (–ü—Ä–µ—Å–µ—Ç—ã)":
            p_name = st.selectbox("–ú–µ—Ç–æ–¥–∏–∫–∞:", list(PRESETS.keys()), key="lite_sel")
            st.session_state.settings["preset_name"] = p_name
        else:
            st.session_state.settings["pro_core"] = st.selectbox(
                "–Ø–î–†–û:", list(PRO_CORES.keys())
            )
            st.session_state.settings["pro_engine"] = st.selectbox(
                "–î–í–ò–ñ–û–ö:", list(PRO_ENGINES.keys())
            )

        st.markdown("---")
        if st.button("üóëÔ∏è –°–ë–†–û–°", type="primary"):
            st.session_state.clear()
            st.rerun()

        # –ñ—É—Ä–Ω–∞–ª –æ—à–∏–±–æ–∫ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é,
        # —á—Ç–æ–±—ã –æ–Ω –Ω–µ –≤–∏–¥–µ–ª —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

    tabs = ["1Ô∏è‚É£ –í–≤–æ–¥", "2Ô∏è‚É£ –ö–æ–Ω—Ü–µ–ø—Ü–∏–∏", "3Ô∏è‚É£ Roadmap", "4Ô∏è‚É£ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"]
    st_tabs = st.tabs(tabs)

    # –í–≤–æ–¥
    with st_tabs[0]:
        st.header("üìù –®–∞–≥ 1: –í–≤–æ–¥–Ω—ã–µ")
        c1, c2 = st.columns(2)
        with c1:
            st.session_state.project_title = st.text_input(
                "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–º–µ–Ω—ã", st.session_state.project_title
            )
            st.session_state.age_group = st.selectbox(
                "–í–æ–∑—Ä–∞—Å—Ç",
                ["6-8 –ª–µ—Ç", "9-11 –ª–µ—Ç", "12-14 –ª–µ—Ç", "15-17 –ª–µ—Ç"],
                index=[
                    "6-8 –ª–µ—Ç",
                    "9-11 –ª–µ—Ç",
                    "12-14 –ª–µ—Ç",
                    "15-17 –ª–µ—Ç",
                ].index(st.session_state.age_group)
                if st.session_state.age_group
                in ["6-8 –ª–µ—Ç", "9-11 –ª–µ—Ç", "12-14 –ª–µ—Ç", "15-17 –ª–µ—Ç"]
                else 1,
            )
            st.session_state.duration_days = st.number_input(
                "–î–Ω–µ–π", 3, 21, st.session_state.duration_days
            )
            st.session_state.brief_idea = st.text_area(
                "–ö—Ä–∞—Ç–∫–∞—è –∏–¥–µ—è —Å–º–µ–Ω—ã (—á–µ—Ä–Ω–æ–≤–∏–∫)",
                st.session_state.brief_idea,
                help="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–∞–ª–∞—Ç–æ—á–Ω—ã–π –ª–∞–≥–µ—Ä—å —Å —É–∫–ª–æ–Ω–æ–º –≤ –≤—ã–∂–∏–≤–∞–Ω–∏–µ –∏ —Å–∫–∞—É—Ç–∏–Ω–≥.",
            )
        with c2:
            st.write("")

        st.markdown("---")
        if st.button("‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ö–æ–Ω—Ü–µ–ø—Ü–∏–∏", type="primary"):
            generate_concepts_pipeline()

    # –ö–æ–Ω—Ü–µ–ø—Ü–∏–∏
    with st_tabs[1]:
        if not st.session_state.concepts_list:
            st.info("–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ 1.")
        else:
            st.header("üí° –®–∞–≥ 2: –í—ã–±–æ—Ä –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏")
            cols = st.columns(3)
            for i, c in enumerate(st.session_state.concepts_list):
                with cols[i % 3]:
                    with st.container(border=True):
                        st.subheader(c.get("–ù–∞–∑–≤–∞–Ω–∏–µ", f"–ö–æ–Ω—Ü–µ–ø—Ü–∏—è {i+1}"))
                        st.write("**–ò–¥–µ—è:**")
                        st.write(c.get("–ò–¥–µ—è", ""))

                        st.write("**–•–æ–¥ —Å–º–µ–Ω—ã:**")
                        raw_plan = c.get("–•–æ–¥_–°–º–µ–Ω—ã", "")
                        for para in str(raw_plan).split("\n"):
                            para = para.strip()
                            if para:
                                st.write(para)

                        if c.get("–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ_–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏"):
                            st.write("**–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**")
                            st.write(c.get("–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ_–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏", ""))
                        if c.get("–†–µ–∑—É–ª—å—Ç–∞—Ç_–†–µ–±–µ–Ω–∫–∞"):
                            st.write("**–†–µ–∑—É–ª—å—Ç–∞—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞:**")
                            st.write(c.get("–†–µ–∑—É–ª—å—Ç–∞—Ç_–†–µ–±–µ–Ω–∫–∞", ""))
                        if st.button("–í—ã–±—Ä–∞—Ç—å —ç—Ç—É –∫–æ–Ω—Ü–µ–ø—Ü–∏—é", key=f"btn_c_{i}"):
                            st.session_state.selected_concept = c
                            st.success(
                                f"–í—ã–±—Ä–∞–Ω–æ: {c.get('–ù–∞–∑–≤–∞–Ω–∏–µ', f'–ö–æ–Ω—Ü–µ–ø—Ü–∏—è {i+1}')}"
                            )

            if st.session_state.selected_concept:
                st.markdown("---")
                st.session_state.user_supplement = st.text_area(
                    "–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è/–æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è:",
                    st.session_state.user_supplement,
                )
                if st.button("üó∫Ô∏è –°–æ–∑–¥–∞—Ç—å Roadmap", type="primary"):
                    generate_roadmap()

    # Roadmap
    with st_tabs[2]:
        if not st.session_state.roadmap:
            st.info("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ Roadmap –Ω–∞ –≤–∫–ª–∞–¥–∫–µ 2.")
        else:
            st.header("üó∫Ô∏è –®–∞–≥ 3: –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–º–µ–Ω—ã (Roadmap)")
            for day in st.session_state.roadmap:
                with st.expander(
                    f"–î–µ–Ω—å {day.get('–î–µ–Ω—å', '?')}: {day.get('–¢–µ–º–∞_–î–Ω—è', '')}"
                ):
                    st.write(f"–¶–µ–ª—å: {day.get('–¶–µ–ª—å_–î–Ω—è', '-')}")
                    st.write(f"–ö–ª—é—á–µ–≤–æ–π –Ω–∞–≤—ã–∫: {day.get('–ö–ª—é—á–µ–≤–æ–π_–ù–∞–≤—ã–∫', '-')}")
            st.success("–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ –¥–Ω—è–º –≥–æ—Ç–æ–≤–∞.")

    # –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    with st_tabs[3]:
        if not st.session_state.roadmap:
            st.warning("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ Roadmap –Ω–∞ –≤–∫–ª–∞–¥–∫–µ 2.")
        else:
            st.header("üìÖ –®–∞–≥ 4: –†–µ–∂–∏–º–Ω—ã–π –º–æ–º–µ–Ω—Ç –∏ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏")
            day_tabs_labels = [
                f"–î–µ–Ω—å {d.get('–î–µ–Ω—å', '?')}" for d in st.session_state.roadmap
            ]
            dt = st.tabs(day_tabs_labels)

            for idx, day_meta in enumerate(st.session_state.roadmap):
                with dt[idx]:
                    d_num = day_meta.get("–î–µ–Ω—å", idx + 1)
                    has_schedule = d_num in st.session_state.schedule_by_day

                    st.subheader(f"–î–µ–Ω—å {d_num}: {day_meta.get('–¢–µ–º–∞_–î–Ω—è', '')}")

                    if not has_schedule:
                        if st.button(
                            f"‚ö° –ù–∞–ø–æ–ª–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º–∏ –î{d_num}",
                            key=f"g_{d_num}",
                            type="primary",
                        ):
                            generate_day_schedule(day_meta)
                    else:
                        if st.button(
                            f"üîÑ –ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å –î–µ–Ω—å {d_num}", key=f"r_{d_num}"
                        ):
                            generate_day_schedule(day_meta)

                        sched = st.session_state.schedule_by_day[d_num]
                        for item in sched:
                            col_time, col_content = st.columns([0.15, 0.85])
                            with col_time:
                                st.text(item.get("time", ""))
                            with col_content:
                                if "fixed" in item:
                                    st.info(item["fixed"])
                                elif item.get("type") == "ai":
                                    data = item.get("data", {})
                                    title = data.get("–ù–∞–∑–≤–∞–Ω–∏–µ", "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å")
                                    with st.expander(f"üé≤ {title}"):
                                        st.markdown(
                                            f"**üéØ –¶–µ–ª—å:** {data.get('–¶–µ–ª—å', '-')}"
                                        )
                                        st.markdown(
                                            f"**üéí –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:** {data.get('–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', '-')}"
                                        )
                                        st.markdown(
                                            f"**üìú –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**\n{data.get('–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è', '-')}"
                                        )
                                        st.markdown(
                                            f"**‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:** {data.get('–†–µ–∑—É–ª—å—Ç–∞—Ç', '-')}"
                                        )


if __name__ == "__main__":
    main()
